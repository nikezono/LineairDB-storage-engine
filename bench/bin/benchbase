#! /bin/bash

set -xu
set -e

if [ $# -eq 0 ]; then
    echo "No arguments supplied."
    echo "This script needs the type of benchmark [ycsb|tpcc]."
    echo "For example: ./bench/bin/exec_benchbase ycsb"
  exit 1
fi

ESC=$(printf '\033[')
message () {
 printf "${ESC}1m%s${ESC}m\n" "$1"
}

cd "$(dirname "$0")"
base_path=$(pwd)/../..
bench_path=$base_path/third_party/benchbase/target

benchmark=$1

### Install and Build
zip_file=$bench_path/benchbase-mysql.zip
ex_file=$bench_path/benchbase-mysql/benchbase.jar
if [ ! -f "$ex_file" ]; then
  message " It seems to be the first-time execution of this script. Clean & Build the mvn package..."

  ### Install JDK-17
  JAVA_HOME=$(/usr/libexec/java_home -v 17)
  if  [[ ${JAVA_HOME} != *"17"* ]]; then
    message '    JDK-17 is not found. Start installing...'
    if [ "$(uname)" == "Darwin" ]; then
      brew install openjdk@17
      export PATH=$(brew --prefix openjdk@17)/bin:$PATH
      sudo ln -sfn $(brew --prefix openjdk@17)/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
    else
      sudo apt install openjdk-17-jdk
    fi
    export JAVA_HOME=$(/usr/libexec/java_home -v 17)
  fi

  ### Build JAR
  cd $bench_path
  ./mvnw clean package -P mysql -e
  unzip $zip_file
  cd -
fi

### Benchmark
message "Execute the benchmarking $benchmark"

step=8
num_threads=(1 $(seq $step $step `nproc`))
#num_threads=(72)
engines=(
  lineairdb 
  innodb 
  myisam 
)

for bm_type in A B C E F; do
#for bm_type in E; do

  if [ $bm_type = A ]; then
    weight=50,0,0,50,0,0
  elif [ $bm_type = B ]; then
    weight=95,0,0,5,0,0
  elif [ $bm_type = C ]; then
    weight=100,0,0,0,0,0
  elif [ $bm_type = E ]; then
    weight=0,5,95,0,0,0
  elif [ $bm_type = F ]; then
    weight=50,0,0,0,0,50
  else
    weight=0,0,0,100,0,0
  fi

  sed -i "s/<weights>.*<\/weights>/<weights>$weight<\/weights>/" $base_path/bench/config/ycsb.xml
  
  for engine in ${engines[@]}; do
      sudo sed -i s/default_storage_engine.*/default_storage_engine=$engine/ /etc/mysql/mysql.conf.d/mysqld.cnf

    for num_thread in ${num_threads[@]}; do
      sudo sed -i "s/innodb_thread_concurrency.*/innodb_thread_concurrency=$num_thread/" /etc/mysql/mysql.conf.d/mysqld.cnf
      sed -i "s/<terminals>.*<\/terminals>/<terminals>$num_thread<\/terminals>/" $base_path/bench/config/ycsb.xml
      sudo systemctl restart mysql
      # /home/tatsu/LineairDB-storage-engine/build/bin/mysql -u bench < $base_path/bench/reset.sql
      mysql -u bench < $base_path/bench/reset.sql

      cd $bench_path/benchbase-mysql
      java -jar $ex_file -b $benchmark -c $base_path/bench/config/$benchmark.xml --create=true --load=true --execute=true

      mkdir -p $base_path/bench/results/$bm_type/$engine/thread_$num_thread
      mv results/*.csv $base_path/bench/results/$bm_type/$engine/thread_$num_thread
    done
  done

  mkdir -p $base_path/bench/plots/ycsb/$bm_type
  cd $base_path/bench/plots/ycsb/$bm_type
  python3 $base_path/bench/bin/plot.py --engine ${engines[@]} --xaxis ${num_threads[@]} --workload $bm_type
done
message 'Finish the benchmarking'
